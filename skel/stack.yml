- name: Render Template
  template: src=jinja_templates/{{ template }} dest=rendered_templates/{{ template | replace(".j2", "") }}

- name: Assume Role
  sts_assume_role:
    role_arn: "{{ role_arn }}"
    role_session_name: "{{ role_session_name }}"
  register: assumed_role

- name: Manage CloudFormation Stack
  cloudformation:
    aws_access_key: "{{ assumed_role.sts_creds.access_key }}"
    aws_secret_key: "{{ assumed_role.sts_creds.secret_key }}"
    security_token: "{{ assumed_role.sts_creds.session_token }}"
    state: "{{ stack_state | default('create') }}"
    stack_name: "{{ stack_prefix ~ '-' ~ name }}"
    tags:
      team: "{{ team_tag }}"
    template: rendered_templates/{{ template | regex_replace("\.j2$","") }}
    diff_command: "{{ diff_command | default('sub_diff') }}" 
    stack_policy_override: "{{ policy_override | default(false) }}"
    stack_policy:
      Statement:
        - Effect: "{% if policy_override is defined and policy_override == 'yes' %}Allow{% else %}Deny{% endif %}"
          Action: [ "Update:Delete", "Update:Replace" ]
          Principal: "*"
          Resource: "*"

        - Effect: Allow
          Action: "Update:*"
          Principal: "*"
          Resource: "*"
